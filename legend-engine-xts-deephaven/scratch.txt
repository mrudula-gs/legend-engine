// Copyright 2020 Goldman Sachs
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package com.gs.alloy.lakehouse.runtime.model.grammar.compiler;

import com.gs.alloy.lakehouse.ingest.api.accessor.protocol.IngestRelationAccessor;
import com.gs.alloy.lakehouse.protocol.pure.v1.model.packageableElement.mapping.IngestRelationColumn;
import com.gs.alloy.lakehouse.protocol.pure.v1.model.packageableElement.mapping.LakehouseClassMapping;
import com.gs.alloy.lakehouse.protocol.pure.v1.model.packageableElement.mapping.LakehousePropertyMapping;
import org.eclipse.collections.api.RichIterable;
import org.eclipse.collections.api.block.function.Function3;
import org.eclipse.collections.api.factory.Lists;
import org.eclipse.collections.api.list.MutableList;
import org.eclipse.collections.api.tuple.Pair;
import org.eclipse.collections.impl.list.mutable.FastList;
import org.eclipse.collections.impl.tuple.Tuples;
import org.eclipse.collections.impl.utility.ListIterate;
import org.finos.legend.engine.language.pure.compiler.toPureGraph.CompileContext;
import org.finos.legend.engine.language.pure.compiler.toPureGraph.HelperMappingBuilder;
import org.finos.legend.engine.language.pure.compiler.toPureGraph.HelperModelBuilder;
import org.finos.legend.engine.language.pure.compiler.toPureGraph.HelperRelationalBuilder;
import org.finos.legend.engine.language.pure.compiler.toPureGraph.SourceInformationHelper;
import org.finos.legend.engine.language.pure.compiler.toPureGraph.extension.CompilerExtension;
import org.finos.legend.engine.language.pure.compiler.toPureGraph.extension.Processor;
import org.finos.legend.engine.protocol.pure.v1.model.context.EngineErrorType;
import org.finos.legend.engine.protocol.pure.v1.model.context.PackageableElementPointer;
import org.finos.legend.engine.protocol.pure.v1.model.context.PackageableElementType;
import org.finos.legend.engine.protocol.pure.v1.model.packageableElement.mapping.ClassMapping;
import org.finos.legend.engine.protocol.pure.v1.model.packageableElement.store.relational.mapping.EmbeddedRelationalPropertyMapping;
import org.finos.legend.engine.protocol.pure.v1.model.packageableElement.store.relational.mapping.InlineEmbeddedPropertyMapping;
import org.finos.legend.engine.protocol.pure.v1.model.packageableElement.store.relational.mapping.OtherwiseEmbeddedRelationalPropertyMapping;
import org.finos.legend.engine.protocol.pure.v1.model.packageableElement.store.relational.mapping.RelationalPropertyMapping;
import org.finos.legend.engine.shared.core.function.Procedure3;
import org.finos.legend.engine.shared.core.operational.errorManagement.EngineException;
import org.finos.legend.pure.generated.Root_meta_external_ingest_accessor_IngestRelationAccessor;
import org.finos.legend.pure.generated.Root_meta_external_ingest_accessor_IngestRelationAccessor_Impl;
import org.finos.legend.pure.generated.Root_meta_external_ingest_mapping_IngestRelationColumn;
import org.finos.legend.pure.generated.Root_meta_external_ingest_mapping_IngestRelationColumn_Impl;
import org.finos.legend.pure.generated.Root_meta_external_ingest_mapping_LakehousePropertyMapping;
import org.finos.legend.pure.generated.Root_meta_external_ingest_mapping_LakehousePropertyMapping_Impl;
import org.finos.legend.pure.generated.Root_meta_external_ingest_metamodel_pure_LakehouseSetImplementation;
import org.finos.legend.pure.generated.Root_meta_external_ingest_metamodel_pure_LakehouseSetImplementation_Impl;
import org.finos.legend.pure.generated.Root_meta_external_ingest_specification_metamodel_IngestDefinition;
import org.finos.legend.pure.generated.Root_meta_external_ingest_specification_metamodel_dataset_Dataset;
import org.finos.legend.pure.generated.Root_meta_pure_metamodel_type_generics_GenericType_Impl;
import org.finos.legend.pure.m3.coreinstance.meta.pure.mapping.EmbeddedSetImplementation;
import org.finos.legend.pure.m3.coreinstance.meta.pure.mapping.Mapping;
import org.finos.legend.pure.m3.coreinstance.meta.pure.mapping.PropertyMapping;
import org.finos.legend.pure.m3.coreinstance.meta.pure.mapping.PropertyMappingsImplementation;
import org.finos.legend.pure.m3.coreinstance.meta.pure.mapping.SetImplementation;
import org.finos.legend.pure.m3.coreinstance.meta.pure.metamodel.PackageableElement;
import org.finos.legend.pure.m3.coreinstance.meta.pure.metamodel.PropertyOwner;
import org.finos.legend.pure.m3.coreinstance.meta.pure.metamodel.function.property.Property;
import org.finos.legend.pure.m3.coreinstance.meta.pure.metamodel.relationship.Association;
import org.finos.legend.pure.m3.coreinstance.meta.pure.metamodel.type.Class;
import org.finos.legend.pure.m3.coreinstance.meta.pure.metamodel.type.generics.GenericType;
import org.finos.legend.pure.m3.coreinstance.meta.relational.mapping.RootRelationalInstanceSetImplementation;
import org.finos.legend.pure.m3.navigation.M3Paths;

import java.util.Collections;
import java.util.List;
import java.util.Optional;
import java.util.Set;

import static org.finos.legend.engine.language.pure.compiler.toPureGraph.HelperModelBuilder.getElementFullPath;

public class LakehouseMappingCompilerExtension implements CompilerExtension
{
    @Override
    public MutableList<String> group()
    {
        return org.eclipse.collections.impl.factory.Lists.mutable.with("PackageableElement", "Mapping");
    }

    @Override
    public CompilerExtension build()
    {
        return new LakehouseMappingCompilerExtension();
    }

    @Override
    public Iterable<? extends Processor<?>> getExtraProcessors()
    {
        return Lists.immutable.with();
    }

    @Override
    public List<Function3<ClassMapping, Mapping, CompileContext, Pair<SetImplementation, RichIterable<EmbeddedSetImplementation>>>> getExtraClassMappingFirstPassProcessors()
    {
        return Collections.singletonList(
                (cm, parentMapping, context) ->
                {
                    if (cm instanceof LakehouseClassMapping)
                    {
                        LakehouseClassMapping classMapping = (LakehouseClassMapping) cm;
                        String id = classMapping.id != null ? classMapping.id : getElementFullPath(context.resolveClass(classMapping._class, classMapping.classSourceInformation), context.pureModel.getExecutionSupport()).replaceAll("::", "_");
                        final Root_meta_external_ingest_metamodel_pure_LakehouseSetImplementation res = new Root_meta_external_ingest_metamodel_pure_LakehouseSetImplementation_Impl(id, SourceInformationHelper.toM3SourceInformation(cm.sourceInformation), context.pureModel.getClass("meta::external::ingest::metamodel::pure::LakehouseSetImplementation"))._id(id);
//                        final RootRelationalInstanceSetImplementation res = new Root_meta_relational_mapping_RootRelationalInstanceSetImplementation_Impl(id, SourceInformationHelper.toM3SourceInformation(cm.sourceInformation), context.pureModel.getClass("meta::relational::mapping::RootRelationalInstanceSetImplementation"))._id(id);
//                        Root_meta_external_ingest_accessor_IngestRelationAccessor tmp = null;
//                        if (classMapping.ingestPtr != null)
//                        {
                            IngestRelationAccessor accessor = classMapping.ingestPtr;

                            PackageableElement packageableElement = context.resolvePackageableElement(accessor.path.get(0), accessor.sourceInformation);

                            Root_meta_external_ingest_specification_metamodel_IngestDefinition definition = (Root_meta_external_ingest_specification_metamodel_IngestDefinition) packageableElement;

                            Root_meta_external_ingest_specification_metamodel_dataset_Dataset dataset = definition._datasets().detect(c -> accessor.path.get(1).equals(c._name()));

                            GenericType genericType = new Root_meta_pure_metamodel_type_generics_GenericType_Impl("", null, context.pureModel.getClass(M3Paths.GenericType))
                                    ._rawType(context.pureModel.getType("meta::external::ingest::accessor::IngestRelationAccessor"))
                                    ._typeArguments(FastList.newListWith(
                                                    new Root_meta_pure_metamodel_type_generics_GenericType_Impl("", null, context.pureModel.getClass(M3Paths.GenericType))
                                                            ._rawType(dataset._source().relationType(context.pureModel.getExecutionSupport()))
                                            )
                                    );
                        Root_meta_external_ingest_accessor_IngestRelationAccessor tmp = new Root_meta_external_ingest_accessor_IngestRelationAccessor_Impl("")
                                    ._classifierGenericType(genericType)
                                    ._ingestDefinition(definition)
                                    ._dataset(dataset);
//                        }
                        res._superSetImplementationId(classMapping.extendsClassMappingId)
                                ._root(classMapping.root)
                                ._ingestPtr(tmp)
                                ._class(context.resolveClass(classMapping._class, classMapping.classSourceInformation))
                                ._propertyMappings(ListIterate.collect(classMapping.propertyMappings, propertyMapping -> processLakehousePropertyMapping(propertyMapping, tmp, context, res, res)))

                                ._parent(parentMapping);
                        if (classMapping.mappingClass != null)
                        {
                            res._mappingClass(HelperMappingBuilder.processMappingClass(classMapping.mappingClass, context, parentMapping));
                        }
                        return Tuples.pair(res, Lists.immutable.empty());
                    }
                    return null;
                }
        );
    }

    private PropertyMapping processLakehousePropertyMapping(LakehousePropertyMapping propertyMapping, Root_meta_external_ingest_accessor_IngestRelationAccessor ra, CompileContext context, Root_meta_external_ingest_metamodel_pure_LakehouseSetImplementation immediateParent,
                                                            Root_meta_external_ingest_metamodel_pure_LakehouseSetImplementation topParent)
    {
        Root_meta_external_ingest_mapping_LakehousePropertyMapping lpm = new Root_meta_external_ingest_mapping_LakehousePropertyMapping_Impl("", SourceInformationHelper.toM3SourceInformation(propertyMapping.sourceInformation), context.pureModel.getClass("meta::external::ingest::mapping::LakehousePropertyMapping"));
        Property property = resolvePropertyForLakehousePropertyMapping(propertyMapping, immediateParent, context);
        lpm._property(property)
                ._localMappingProperty(propertyMapping.localMappingProperty != null)
                ._relationalColumn(processRelationalOperationElement(propertyMapping.relationalColumn, ra, context, Lists.mutable.empty()))
                ._sourceSetImplementationId(getPropertyMappingSourceId(propertyMapping, immediateParent, property, context))
                ._targetSetImplementationId(getPropertyMappingTargetId(propertyMapping, immediateParent, property, context))
                ._owner(immediateParent);
        lpm.setSourceInformation(SourceInformationHelper.toM3SourceInformation(propertyMapping.sourceInformation));
        return lpm;
    }

    public static String getPropertyMappingSourceId(org.finos.legend.engine.protocol.pure.v1.model.packageableElement.mapping.PropertyMapping propertyMapping, PropertyMappingsImplementation parent, Property<?, ?> property, CompileContext context)
    {
        if (!(propertyMapping instanceof LakehousePropertyMapping))
        {
            throw new UnsupportedOperationException();
        }

        if (propertyMapping.source != null)
        {
            return propertyMapping.source;
        }

        PropertyOwner owner = property._owner();
        if ((parent._id() == null) && (owner instanceof Association))
        {
            Property<?, ?> prop = ((Class<?>) property._genericType()._rawType())._propertiesFromAssociations().detect(p -> owner.equals(p._owner()));
            return HelperModelBuilder.getTypeFullPath(prop._genericType()._rawType(), "_", context.pureModel.getExecutionSupport());
        }
        return parent._id();
    }

    public static String getPropertyMappingTargetId(org.finos.legend.engine.protocol.pure.v1.model.packageableElement.mapping.PropertyMapping propertyMapping, PropertyMappingsImplementation parent, Property<?, ?> property, CompileContext context)
    {
        if (!(propertyMapping instanceof LakehousePropertyMapping))
        {
            throw new UnsupportedOperationException();
        }
        if (propertyMapping.target == null && property._genericType()._rawType() instanceof Class)
        {
            return HelperModelBuilder.getTypeFullPath(property._genericType()._rawType(), "_", context.pureModel.getExecutionSupport());
        }
        return HelperMappingBuilder.getPropertyMappingTargetId(propertyMapping);
    }

    private Root_meta_external_ingest_mapping_IngestRelationColumn processRelationalOperationElement(IngestRelationColumn relationalColumn, Root_meta_external_ingest_accessor_IngestRelationAccessor ra, CompileContext context, MutableList<Object> empty)
    {
        org.finos.legend.pure.m4.coreinstance.SourceInformation m3SourceInformation = SourceInformationHelper.toM3SourceInformation(relationalColumn.sourceInformation);

//            Relation relation = getRelation((Database) context.resolveStore(tableAliasColumn.table.database, tableAliasColumn.table.sourceInformation), tableAliasColumn.table.schema, tableAliasColumn.table.table, tableAliasColumn.table.sourceInformation);
//            Column col = getColumn(relation, tableAliasColumn.column, tableAliasColumn.sourceInformation);
//            TableAlias alias = aliasMap.getIfAbsentPut(tableAliasColumn.table.schema + "." + tableAliasColumn.tableAlias, () -> new Root_meta_relational_metamodel_TableAlias_Impl("", null, context.pureModel.getClass("meta::relational::metamodel::TableAlias"))
//                    ._name(tableAliasColumn.tableAlias)
//                    ._relationalElement(col._owner())
//                    ._database(HelperRelationalBuilder.resolveDatabase(tableAliasColumn.table.getDb(), tableAliasColumn.table.sourceInformation, context)));


            return new Root_meta_external_ingest_mapping_IngestRelationColumn_Impl("", m3SourceInformation, context.pureModel.getClass("meta::external::ingest::mapping::IngestRelationColumn"))
                    ._ingestAccessor(ra)._Column(relationalColumn.Column);
//                    ._Column();

//                    ._columnName(col._name())
//                    ._column(col)
//                    ._alias(alias);
    }

    private Property resolvePropertyForLakehousePropertyMapping(LakehousePropertyMapping propertyMapping, Root_meta_external_ingest_metamodel_pure_LakehouseSetImplementation immediateParent, CompileContext context)
    {
        String propertyName = propertyMapping.property.property;
//        String edgePointPropertyName = MilestoningFunctions.getEdgePointPropertyName(propertyName);
        Class<?> _class = getPropertyOwnerForRelationalPropertyMapping(context, propertyMapping, immediateParent);
        return HelperModelBuilder.getPropertyOrResolvedEdgePointProperty(context, _class, Optional.empty(), propertyName, true, propertyMapping.sourceInformation);
    }

    private Class<?> getPropertyOwnerForRelationalPropertyMapping(CompileContext context, LakehousePropertyMapping propertyMapping, Root_meta_external_ingest_metamodel_pure_LakehouseSetImplementation immediateParent)
    {
        if (propertyMapping.property._class != null)
        {
            PropertyOwner owner = context.resolvePropertyOwner(propertyMapping.property._class, propertyMapping.property.sourceInformation);
            return owner instanceof Class<?> ? (Class<?>) owner : HelperModelBuilder.getAssociationPropertyClass((Association) owner, propertyMapping.property.property, propertyMapping.property.sourceInformation, context);
        }
        else
        {
            throw new EngineException("Can't find property owner class for property" + propertyMapping.property.property, propertyMapping.property.sourceInformation, EngineErrorType.COMPILATION);
        }
    }

//    @Override
//    public List<Procedure3<ClassMapping, Mapping, CompileContext>> getExtraClassMappingSecondPassProcessors()
//    {
//        return Collections.singletonList(
//                (cm, parentMapping, context) ->
//                {
//                    if (cm instanceof LakehouseClassMapping)
//                    {
//                        LakehouseClassMapping classMapping = (LakehouseClassMapping) cm;
//                        RootRelationalInstanceSetImplementation rsi = (RootRelationalInstanceSetImplementation) parentMapping._classMappings().detect(c -> HelperRelationalBuilder.getClassMappingId(c).equals(HelperMappingBuilder.getClassMappingId(classMapping, context)));
//
//                        HelperRelationalBuilder.processRootRelationalClassMapping(rsi, classMapping, context);
//                    }
//                }
//        );
//    }

    @Override
    public List<Procedure3<ClassMapping, CompileContext, Set<PackageableElementPointer>>> getExtraClassMappingPrerequisiteElementsPassProcessors()
    {
        return Collections.singletonList(
                (cm, context, prerequisiteElements) ->
                {
                    if (cm instanceof LakehouseClassMapping)
                    {
                        LakehouseClassMapping classMapping = (LakehouseClassMapping) cm;
                        prerequisiteElements.add(new PackageableElementPointer(PackageableElementType.CLASS, classMapping._class, classMapping.classSourceInformation));
                        if (classMapping.ingestPtr != null)
                        {
                            prerequisiteElements.add(new PackageableElementPointer(null, classMapping.ingestPtr.path.get(0), classMapping.ingestPtr.sourceInformation));
                        }
                        if (classMapping.mappingClass != null)
                        {
                            HelperMappingBuilder.collectPrerequisiteElementsFromMappingClass(prerequisiteElements, classMapping.mappingClass, context);
                        }
//                        ListIterate.forEach(classMapping.propertyMappings, propertyMapping -> collectPrerequisiteElementsFromLakehousePropertyMapping(prerequisiteElements, propertyMapping.relationalColumn));
                    }
                }
        );
    }

//    public static void collectPrerequisiteElementsFromLakehousePropertyMapping(Set<PackageableElementPointer> prerequisiteElements, IngestRelationColumn column)
//    {
//        if (operationElement instanceof org.finos.legend.engine.protocol.pure.v1.model.packageableElement.store.relational.model.operation.TableAliasColumn)
//        {
//            org.finos.legend.engine.protocol.pure.v1.model.packageableElement.store.relational.model.operation.TableAliasColumn tableAliasColumn = (org.finos.legend.engine.protocol.pure.v1.model.packageableElement.store.relational.model.operation.TableAliasColumn) operationElement;
//            // Self join
//            if (!(tableAliasColumn.table.table.equals(SELF_JOIN_TABLE_NAME) && tableAliasColumn.tableAlias.equals(SELF_JOIN_TABLE_NAME)))
//            {
//                prerequisiteElements.add(new PackageableElementPointer(PackageableElementType.STORE, tableAliasColumn.table.database, tableAliasColumn.table.sourceInformation));
//                prerequisiteElements.add(new PackageableElementPointer(PackageableElementType.STORE, tableAliasColumn.table.getDb(), tableAliasColumn.table.sourceInformation));
//            }
//        }
//    }

//    @Override
//    public List<BiConsumer<PureModel, MappingValidatorContext>> getExtraMappingPostValidators()
//    {
//        return Collections.singletonList(RelationalValidator::validateRelationalMapping);
//    }
}
